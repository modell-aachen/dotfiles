manifest-files() {
    echo $(grep "^[^#]" $CORE_REPO/lib/Foswiki/Contrib/core/MANIFEST | cut -d ' ' -f1 | tr '\n' ' ')
}

qore-install() {
    local user=www-data

    qore-link() {
        local file=$1
        local fullpath=$2
        local dest=${file/$CORE_REPO/$FOSWIKI_ROOT}

        if [ -L "$dest" ]; then
            return
        fi

        if [ ! -f "$dest"  ]; then
            sudo -u $user mkdir -p $(dirname "$dest")
            sudo -u $user cp -r "$file" "$dest"
        fi
        sudo -u $user ln -sf "$file" "$dest"
    }

    local options=("$@")
    if [ -z "$@" ]; then
        options=("$(manifest-files)")
    fi

    for option in "${options[@]}"; do
        local path
        case $option in
            frontend)
                path=pub/System/js
                ;;
            *)
                path=$option
                ;;
        esac
        local fullpath=$CORE_REPO/$path
        if [ -d "$fullpath" ]; then
            for src in $(find $fullpath -type f); do
                qore-link $src $fullpath
            done
        elif [ -f "$fullpath" ]; then
            qore-link $fullpath $fullpath
        fi
    done
    sudo systemctl restart qwikiRestart
    echo "Success!"
}

_qore-install-completion() {
    local cur

    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"

    COMPREPLY=( $(compgen -W "frontend $(manifest-files)" -- ${cur}) )
    return 0
}


complete -F _qore-install-completion qore-install
