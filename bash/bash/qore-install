qore-install() {
    local user=www-data
    local repopath=/opt/repos/FoswikiContrib/core

    qore-link() {
        local file=$1
        local fullpath=$2
        local dest=${file/$repopath/$FOSWIKI_ROOT}

        if [ -L "$dest" ]; then
            return
        fi

        if [ ! -f "$dest"  ]; then
            sudo -u $user mkdir -p $(dirname "$dest")
            sudo -u $user cp -r "$file" "$dest"
        fi
        sudo -u $user ln -sf "$file" "$dest"
    }

    for option in "$@"; do
        local path
        case $option in
            frontend)
                path=pub/System/js
                ;;
            *)
                path=$option
                ;;
        esac
        local fullpath=$repopath/$path
        if [ -d "$fullpath" ]; then
            for src in $(find $fullpath -type f); do
                qore-link $src $fullpath
            done
        elif [ -f "$fullpath" ]; then
            qore-link $fullpath $fullpath
        fi
    done
    sudo systemctl restart qwikiRestart
    echo "Success!"
}

_qore-install-completion() {
    local cur
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"

    local options="frontend"
    for dir in tools templates lib locale; do
        local repopath=/opt/repos/FoswikiContrib/core
        for file in $(find $repopath/$dir -type f); do
            options+=" ${file/$repopath\//}"
        done
    done

    COMPREPLY=( $(compgen -W "$options" -- ${cur}) )
    return 0
}


complete -F _qore-install-completion qore-install
