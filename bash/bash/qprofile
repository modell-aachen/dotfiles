qprofile() {
    usage() {
        cat << USAGE
Usage:
  qprofile [subcommand]

subcommands
  enable   enables profiling in systemd service
  disable  disables profiling
  compile  converts profiling files into the html folder /opt/repos/nytprof

Flags:
  -h, --help  shows this help message
USAGE
    }

    qwiki_start() {
        sudo systemctl start qwiki.service
    }

    qwiki_stop() {
        sudo systemctl stop qwiki.service
    }

    qwiki_reload() {
        qwiki_stop
        sudo systemctl daemon-reload
    }

    enable() {
        sudo sed -i -e 's#\$app->configureAsyncDomainEvents(\$app);#\$app->configureAsyncDomainEvents(\$app);\n    \$app->plugin( NYTProf => \$mojoConfig );#' /var/www/qwikis/core/lib/Qwiki/Common/Infrastructure/Api/App.pm
        qwiki_reload
        qwiki_start
    }

    disable() {
        sudo sed -i '/\$app->plugin( NYTProf => \$mojoConfig );/d' /var/www/qwikis/core/lib/Qwiki/Common/Infrastructure/Api/App.pm
        qwiki_reload
        qwiki_start
    }

    compile() {
        cd /var/www/qwikis/core/profiles
        sudo -u www-data nytprofhtml -f nytprof* -o /opt/repos/nytprof
        cd -
    }


    OPTS=`getopt -o h --long help -- "$@"`
    if [ $? != 0 ] ; then echo "Failed parsing options." >&2 ; exit 1 ; fi

    eval set -- "$OPTS"

    while true; do
        case "$1" in
            -h | --help )
                usage
                return
                shift ;;
            -- )
                shift
                break ;;
            * )
                break ;;
        esac
    done

    shift $(expr $OPTIND - 1 )

    local subcommand=${1}

    case "$subcommand" in
        enable )
            enable
            ;;
        disable )
            disable
            ;;
        compile )
            compile
            ;;
        * )
            echo "subcommand '$subcommand' not found!"
            ;;
    esac
}

_qprofile-completion()
{
    local cur="${COMP_WORDS[COMP_CWORD]}"
    COMPREPLY=( $(compgen -W "enable disable compile -h" -- $cur) )
}


complete -F _qprofile-completion qprofile

